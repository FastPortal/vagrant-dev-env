<!DOCTYPE html><html><head><meta charset="UTF-8"><style>html { font-size: 100%; overflow-y: scroll; -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; }

body{
  color:#444;
  font-family:Georgia, Palatino, 'Palatino Linotype', Times,
              'Times New Roman', serif,
              "Hiragino Sans GB", "STXihei", "微软雅黑";
  font-size:12px;
  line-height:1.5em;
  background:#fefefe;
  width: 45em;
  margin: 10px auto;
  padding: 1em;
  outline: 1300px solid #FAFAFA;
}

a{ color: #0645ad; text-decoration:none;}
a:visited{ color: #0b0080; }
a:hover{ color: #06e; }
a:active{ color:#faa700; }
a:focus{ outline: thin dotted; }
a:hover, a:active{ outline: 0; }

span.backtick {
  border:1px solid #EAEAEA;
  border-radius:3px;
  background:#F8F8F8;
  padding:0 3px 0 3px;
}

::-moz-selection{background:rgba(255,255,0,0.3);color:#000}
::selection{background:rgba(255,255,0,0.3);color:#000}

a::-moz-selection{background:rgba(255,255,0,0.3);color:#0645ad}
a::selection{background:rgba(255,255,0,0.3);color:#0645ad}

p{
margin:1em 0;
}

img{
max-width:100%;
}

h1,h2,h3,h4,h5,h6{
font-weight:normal;
color:#111;
line-height:1em;
}
h4,h5,h6{ font-weight: bold; }
h1{ font-size:2.5em; }
h2{ font-size:2em; border-bottom:1px solid silver; padding-bottom: 5px; }
h3{ font-size:1.5em; }
h4{ font-size:1.2em; }
h5{ font-size:1em; }
h6{ font-size:0.9em; }

blockquote{
color:#666666;
margin:0;
padding-left: 3em;
border-left: 0.5em #EEE solid;
}
hr { display: block; height: 2px; border: 0; border-top: 1px solid #aaa;border-bottom: 1px solid #eee; margin: 1em 0; padding: 0; }


pre , code, kbd, samp { 
  color: #000; 
  font-family: monospace; 
  font-size: 0.88em; 
  border-radius:3px;
  background-color: #F8F8F8;
  border: 1px solid #CCC; 
}
pre { white-space: pre; white-space: pre-wrap; word-wrap: break-word; padding: 5px;}
pre code { border: 0px !important; }
code { padding: 0 3px 0 3px; }

b, strong { font-weight: bold; }

dfn { font-style: italic; }

ins { background: #ff9; color: #000; text-decoration: none; }

mark { background: #ff0; color: #000; font-style: italic; font-weight: bold; }

sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }
sup { top: -0.5em; }
sub { bottom: -0.25em; }

ul, ol { margin: 1em 0; padding: 0 0 0 2em; }
li p:last-child { margin:0 }
dd { margin: 0 0 0 2em; }

img { border: 0; -ms-interpolation-mode: bicubic; vertical-align: middle; }

table { border-collapse: collapse; border-spacing: 0; }
td { vertical-align: top; }

@media only screen and (min-width: 480px) {
body{font-size:14px;}
}

@media only screen and (min-width: 768px) {
body{font-size:16px;}
}

@media print {
  * { background: transparent !important; color: black !important; filter:none !important; -ms-filter: none !important; }
  body{font-size:12pt; max-width:100%;}
  a, a:visited { text-decoration: underline; }
  hr { height: 1px; border:0; border-bottom:1px solid black; }
  a[href]:after { content: " (" attr(href) ")"; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after { content: ""; }
  pre, blockquote { border: 1px solid #999; padding-right: 1em; page-break-inside: avoid; }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page :left { margin: 15mm 20mm 15mm 10mm; }
  @page :right { margin: 15mm 10mm 15mm 20mm; }
  p, h2, h3 { orphans: 3; widows: 3; }
  h2, h3 { page-break-after: avoid; }
}</style></head><body><h1 id="bowling-game-kata-using-mocha-bdd-test-framework-and-yeoman">Bowling Game Kata using Mocha (BDD) Test framework and Yeoman</h1>

<h2 id="about-this-tutorial">About this Tutorial…</h2>

<p>This tutorial was created in an effort to learn more about using new tools like Yeoman and the Mocha test framework using <a href="http://nodejs.org/" title="Node.js">Node.js</a> that can be executed in a headless browser environment (<a href="http://phantomjs.org/" title="PhantomJS - headless WebKit w/ JavaScript API">phantomjs</a>), and to assist other engineers in learning the practice of behavior driven development. Basically, this article is a result of following the <a href="http://butunclebob.com/ArticleS.UncleBob.TheBowlingGameKata" title="The Bowling Game Kata">'kata' by Uncle Bob</a> to author a simple program in JavaScript that scores a <a href="http://en.wikipedia.org/wiki/Ten-pin_bowling" title="Ten pin bowling game Wikipedia article">game of ten-pin bowling</a>.</p>

<p>Covered in this tutorial:</p>

<ol>
<li>Using the <a href="http://visionmedia.github.com/mocha/" title="Mocha Test Framework">Mocha test framework</a> with behavior-driven development (<a href="http://blog.dannorth.net/introducing-bdd/" title="Behavior-Driven Development">BDD</a>)  </li>
<li><a href="http://butunclebob.com/ArticleS.UncleBob.TheBowlingGameKata" title="The Bowling Game Kata">Uncle Bob's "Bowling Game" kata</a> in JavaScript</li>
<li>Quickly setting up your development environment with <a href="https://github.com/pixelhandler/vagrant-dev-env" title="Vagrant Development Environment">Vagrant, VirtualBox</a> and <a href="http://yeoman.io/" title="Yeoman - set of tools">Yeoman</a> </li>
<li>First, writing <a href="http://chaijs.com/api/bdd/" title="Chai BDD Assertion Library">tests</a> to describe the expected behaviors which fail  </li>
<li>Next, writing application code which passes the tests  </li>
<li>The result: a program that <a href="http://slocums.homestead.com/gamescore.html" title="The Basics of Keeping Score">scores a game of bowling</a>, and better BDD skills</li>
</ol>

<p>Inspired my Robert Martin's 'Bowling Game Kata' (a programmer's exercise) I followed Uncle Bob's presentation of the test-driven development exercise to write a program that scores a bowling game and documented the code written in JavaScript. This tutorial content is not my own but rather an exercise of making the Bowling Game Kata my own practice, so I've borrowed the kata from Uncle Bob along with his class diagrams and ten-pin bowling graphic. The headings in this tutorial from the 'Quick Design Session' through the 'Fifth Test' make up the essence of Uncle Bob's presentation. Thank you <a href="https://twitter.com/unclebobmartin" title="Uncle Bob Martin on Twitter">Uncle Bob</a> for putting together an excellent exercise!</p>

<p>Note: The code examples in this tutorial will use <code>git diff</code> style indicators, lines with the first character <code>+</code>/<code>-</code> show an action to add(+) or remove(-) a line of code.</p>

<h3 id="test-driven-development-tdd">Test-driven development (TDD)</h3>

<p>A software development process that relies on the repetition of a very short development cycle: <strong>first</strong> the developer writes a <strong>failing automated test case</strong> that defines a desired improvement or new function, <strong>then</strong> produces <strong>code to pass that test</strong> and finally refactors the new code to acceptable standards.</p>

<p>See: <a href="http://en.wikipedia.org/wiki/Test-driven_development" title="Test-Driven Development">http://en.wikipedia.org/wiki/Test-driven_development</a></p>

<p><em>“Test-driven development constantly repeats the steps of adding test cases that fail, passing them, and refactoring. Receiving the expected test results at each stage reinforces the programmer’s mental model of the code, boosts confidence and increases productivity.”</em></p>

<h4 id="the-tdd-process">The TDD Process</h4>

<ol>
<li>Add a test</li>
<li>Run all tests and see if the new one fails</li>
<li>Write some code</li>
<li>Run the automated tests and see them succeed</li>
<li>Refactor code</li>
<li>Repeat</li>
</ol>

<p>Basically <em><a href="http://en.wikipedia.org/wiki/Test-driven_development" title="Test-Driven Development">Lather, Rinse, Repeat</a></em></p>

<h4 id="behavior-driven-development-bdd">Behavior-driven development (BDD)</h4>

<p>See: Introducing BDD : <a href="http://blog.dannorth.net/introducing-bdd/" title="Behavior-Driven Development">http://blog.dannorth.net/introducing-bdd/</a></p>

<p>Use language/terminology that everyone on the project understands; using a pattern (e.g. Given, When, Then.) to test expected behavior.</p>

<p><em>“Developers discovered it could do at least some of their documentation for them, so they started to write test methods that were real sentences.”</em></p>

<h2 id="vagrant-development-environment">Vagrant Development Environment</h2>

<p>Vagrant <a href="https://github.com/pixelhandler/vagrant-dev-env" title="Vagrant Development Environment">development environment</a> provisioned with shell scripts on a (linux/ubuntu) precise64 box. The first time you execute <code>vagrant up</code> the provision scripts will download a linux box "precise64" and install some software needed for a development box. You can edit the provision.sh or scripts in the /bin directory to customize your environment or skip some installations. It may take about 10 minutes to download and install.</p>

<pre><code>cd ~/code/
git clone https://github.com/pixelhandler/vagrant-dev-env ./bowlingkata
cd bowlingkata
git submodule init
git submodule update
vagrant up
</code></pre>

<p>Update your /etc/hosts file, add: <code>192.168.50.4 precise64</code> the vagrant/virtual box will use <a href="http://precise64/">http://precise64/</a> or <a href="http://192.168.50.4/">http://192.168.50.4/</a> for the www root. You could use any domain you like, the <code>precise64</code> apache vhost runs from on the IP address: 192.168.50.4 so <code>192.168.50.4 precise64.dev</code> works too, <a href="http://precise64.dev/">http://precise64.dev/</a> may be easier to use in a browser.</p>

<h2 id="scoring-bowling">Scoring Bowling</h2>

<p><img src="https://raw.github.com/pixelhandler/vagrant-dev-env/bowling/www/app/images/ten-pins.jpg" alt="Complete game" title="Uncle Bob game" /></p>

<p>The game consists of 10 frames as shown above.  In each frame the player has two opportunities to knock down 10 pins.  The score for the frame is the total number of pins knocked down, plus bonuses for strikes and spares.</p>

<p>A spare is when the player knocks down all 10 pins in two tries.  The bonus for that frame is the number of pins knocked down by the next roll.  So in frame 3 above, the score is 10 (the total number knocked down) plus a bonus of 5 (the number of pins knocked down on the next roll.)</p>

<p>A strike is when the player knocks down all 10 pins on his first try.  The bonus for that frame is the value of the next two balls rolled.</p>

<p>In the tenth frame a player who rolls a spare or strike is allowed to roll the extra balls to complete the frame.  However no more than three balls can be rolled in tenth frame.</p>

<p>For more info see <a href="http://en.wikipedia.org/wiki/Ten-pin_bowling" title="Ten pin bowling game Wikipedia article">Ten-pin bowling game Wikipedia article</a> and article for <a href="http://www.bowlingindex.com/instruction/scoring.htm" title="Scoring a bowling game">Instructions on scoring with game examples</a></p>

<h2 id="the-requirements">The Requirements</h2>

<pre><code>+--------------------+
| Game               |
| ------------------ |
| + roll(pins : int) |
| + score() : int    |
+--------------------+
</code></pre>

<p>Write a class named “Game” that has two methods:  </p>

<ul>
<li><strong>roll(pins : int)</strong> is called each time the player rolls a ball.  The argument is the number of pins knocked down.  </li>
<li><strong>score() : int</strong> is called only at the very end of the game.  It returns the total score for that game.</li>
</ul>

<h2 id="quick-design-session">Quick Design Session</h2>

<ol>
<li>Clearly we need the Game class. <img src="https://raw.github.com/pixelhandler/vagrant-dev-env/bowling/www/app/images/game_class.png" alt="Game class" title="Game class" /></li>
<li>A game has 10 frames.  <img src="https://raw.github.com/pixelhandler/vagrant-dev-env/bowling/www/app/images/frame_class.png" alt="Frame class" title="Frame class" /></li>
<li>A frame has 1 or two rolls.  <img src="https://raw.github.com/pixelhandler/vagrant-dev-env/bowling/www/app/images/roll_class.png" alt="Roll class" title="Roll class" /></li>
<li>The tenth frame has two or three rolls. It is different from all the other frames.  <img src="https://raw.github.com/pixelhandler/vagrant-dev-env/bowling/www/app/images/tenth_frame_class.png" alt="Tenth frame" title="Tenth frame" /></li>
<li>The score function must iterate through all the frames, and calculate all their scores.  <img src="https://raw.github.com/pixelhandler/vagrant-dev-env/bowling/www/app/images/frame_class_score.png" alt="Score method" title="Score method" /></li>
<li>The score for a spare or a strike depends on the frame’s successor  <img src="https://raw.github.com/pixelhandler/vagrant-dev-env/bowling/www/app/images/frame_class_next.png" alt="Next frame" title="Next frame" /></li>
</ol>

<h2 id="begin">Begin</h2>

<h3 id="create-a-project-in-vagrantwww">Create a project in /vagrant/www</h3>

<p>Issue some vagrant and yeoman commands to get started</p>

<pre><code>git checkout -b bowling
vagrant ssh
git config --global user.name "Your Name"
git config --global user.email "me@dom.com"
cd /vagrant/www
yeoman init
# Answer Y/n (make yeoman better), then... n, n, Y (RequireJS), n, N to yeoman.
git add .
git commit -m "yeoman init"
yeoman test
yeoman server
# see http://precise64.dev:3501/ 
# stop yeoman server with control-c, `exit` (vagrant ssh); or stay in bowlingkata and use vimvim
</code></pre>

<p>Now you should have /vagrant/www/app and vagrant/www/test directories this is where we will write some code in. </p>

<p><em>Note:</em> You do not have to use the vagrant development environment to complete this tutorial (kata); you could just open the test file in your browser to execute the tests and view the mocha report. If you are not using the virtual box / vagrant environment then be sure to modify <code>/vagrant/www/</code> to the path to your working directory.</p>

<p>Edit app/scripts/main.js add <code>app: 'app',</code> and delete a few lines, all you will need is the <code>paths</code> object:</p>

<pre><code> require.config({
-  shim: {
-  },
-
   paths: {
+    app: 'app',
     jquery: 'vendor/jquery.min'
   }
 });
- 
-require(['app'], function(app) {
-  // use app here
-  console.log(app);
-});
</code></pre>

<p>Create symbolic link for <code>scripts</code> in the test directory, to load <a href="http://requirejs.org/docs/requirements.html" title="RequireJS Library for dependency management and build optimization">require.js</a> and main.js with one script element:</p>

<pre><code>cd /vagrant/www/test
ln -s ../app/scripts ./scripts
</code></pre>

<p>The test runner index.html (see below) will use the directory <code>www/app/scripts</code> via the symbolic link (see above) to load the application's RequireJS main configuration file and to load the RequireJS library.</p>

<p>Edit file: /test/index.html - use this markup:</p>

<pre><code>&lt;!doctype html&gt;
&lt;head&gt;
  &lt;meta charset="utf-8"&gt;
  &lt;meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"&gt;
  &lt;title&gt;Mocha Spec Runner&lt;/title&gt;
  &lt;link rel="stylesheet" href="lib/mocha/mocha.css"&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div id="mocha"&gt;&lt;/div&gt;

  &lt;script src="lib/mocha/mocha.js"&gt;&lt;/script&gt;
  &lt;script src="lib/chai.js"&gt;&lt;/script&gt;
  &lt;script data-main="scripts/main" src="scripts/vendor/require.js"&gt;&lt;/script&gt;

  &lt;script&gt;
    mocha.setup({ui: 'bdd', ignoreLeaks: true});
    expect = chai.expect;
    require(['../spec/game.spec'], function () {
      setTimeout(function () {
        require(['../runner/mocha']);
      }, 100);
    });
  &lt;/script&gt;

&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>It will be very helpful to change the lint task in the (yeoman) generated file, Gruntfile.js, e.g. to ignore the vendor directory (and other subdirectories); also to lint the test directory with the command: <code>yeoman lint</code>.</p>

<pre><code>     lint: {
       files: [
         'Gruntfile.js',
-        'app/scripts/**/*.js',
+        'app/scripts/*.js',
+        'test/spec/*.js'
       ]
</code></pre>

<h2 id="first-test-a-gutter-game">First Test, A Gutter Game</h2>

<h3 id="create-a-unit-test-in-testspecgamespecjs">Create a unit test in test/spec/game.spec.js</h3>

<pre><code>cd /vagrant/www/test/spec &amp;&amp; touch game.spec.js
cd /vagrant/www/app/scripts &amp;&amp; touch Game.js
</code></pre>

<h3 id="add-a-failing-test-for-a-gutter-game">Add a failing test for a gutter game.</h3>

<p>Add code to test/spec/game.spec.js</p>

<pre><code>+// Bowling Game specs
+
+describe("Ten-Ping Bowling Kata", function () {
+
+    describe("Gutter Game", function () {
+
+        it("should score 0 for a gutter game, all rolls are 0", function () {
+            var game = new Game();
+        });
+
+    });
+
+});
</code></pre>

<h3 id="execute-this-program-and-verify-that-you-get-an-error">Execute this program and verify that you get an error</h3>

<pre><code>cd /vagrant/www/
</code></pre>

<h4 id="run-the-spec-yeoman-test-should-fail">Run the spec, <code>yeoman test</code> should FAIL</h4>

<p>You should get a message "Can't find variable: Game"</p>

<h3 id="pass-the-failing-test-by-adding-game-constructor">Pass the failing test, by adding Game constructor</h3>

<p>Add code in app/scripts/Game.js</p>

<pre><code>+define('game', function () {
+    var Game = function () {};
+
+    return Game;
+});
</code></pre>

<p>Add <code>game: 'Game'</code> to requirejs config in app/scripts/main.js</p>

<pre><code> require.config({
   paths: {
     app: 'app',
+    game: 'Game',
     jquery: 'vendor/jquery.min'
   }
 });
</code></pre>

<p>Update spec in test/spec/game.spec.js adding a <code>require</code> call for the Game constructor, wrap the entire describe call with...</p>

<pre><code>+require(['game'], function (Game) {
+
 describe("Ten-Ping Bowling Kata", function () {
</code></pre>

<p>…</p>

<pre><code> });
+
+});
</code></pre>

<h4 id="run-the-spec-yeoman-test-should-pass">Run the spec, <code>yeoman test</code> should PASS</h4>

<p>You can also visit <a href="http://precise64.dev/test/">http://precise64.dev/test/</a> in your browser; the vagrant provisioning task setup the precise64.dev virtual host for you. The precise64.dev domain renders the files served by apache from the <code>/vagrant/www</code> directory, and is accessible to your browser as long as your hosts file has the entry <code>192.168.50.4 precise64.dev</code>.</p>

<h3 id="continue-the-specs-for-a-gutter-game">Continue the specs for a gutter game</h3>

<h4 id="add-a-failing-test-for-a-gutter-game-and-stub-roll-and-score-methods">Add a failing test for a gutter game, and stub roll() and score() methods</h4>

<p>Add an assertion to test/spec/game.spec.js</p>

<pre><code>         it("should score 0 for a gutter game, all rolls are 0", function () {
-            var game = new Game();
+            var game = new Game(), i = 0;
+
+            for (i; i &lt; 20; i ++) {
+                game.roll(0);
+            }
+            expect(game.score()).to.equal(0);
         });
</code></pre>

<p>Add some stub methods in app/scripts/Game.js</p>

<pre><code> define('game', function () {
     var Game = function () {};

+    Game.prototype.roll = function (pins) {
+        if (typeof pins !== 'number') {
+            throw new Error("expeced a number");
+        }
+    };
+
+    Game.prototype.score = function () {
+        return -1;
+    };
+
     return Game;
 });
</code></pre>

<h4 id="run-the-spec-yeoman-test-should-fail-2">Run the spec, <code>yeoman test</code> should FAIL</h4>

<p>You should get an error message "expected -1 to equal 0"</p>

<h3 id="pass-failing-test-with-code-change-in-appscriptsgamejs">Pass failing test with code change in app/scripts/Game.js</h3>

<pre><code> define('game', function () {
-    var Game = function () {};
+    var Game = function () {
+        this._score = 0;
+    };

     Game.prototype.roll = function (pins) {
         if (typeof pins !== 'number') {
             throw new Error('Game.role() expects `pins` argument to be a number');
         }
+        this._score += pins;
     };

     Game.prototype.score = function () {
-        return -1;
+        return this._score;
     };

     return Game;
</code></pre>

<h4 id="run-the-spec-yeoman-test-should-pass-2">Run the spec, <code>yeoman test</code> should PASS</h4>

<h2 id="second-test-game-with-every-roll-hitting-1-pin">Second Test, Game With Every Roll Hitting 1 Pin</h2>

<h3 id="add-new-test-for-scoring-a-game-of-all-20-rolls-only-hitting-1-pin">Add new test for scoring a game of all 20 rolls only hitting 1 pin</h3>

<pre><code>+    describe("Score game given all rolls hit only one pin", function () {
+
+        it("should score 20", function () {
+            var game = new Game(), i = 0;
+
+            for (i; i &lt; 20; i ++) {
+                game.roll(1);
+            }
+            expect(game.score()).to.equal(20);
+        });
+
+    });
</code></pre>

<h4 id="run-the-spec-yeoman-test-should-pass-3">Run the spec, <code>yeoman test</code> should PASS</h4>

<h3 id="refactor-testspecgamespecjs-to-make-test-more-dry-dont-repeat-yourself">Refactor test/spec/game.spec.js to make test more DRY (don't repeat yourself)</h3>

<p>Each test instantiates a game object, use a <code>beforeEach</code> method; also add a <code>rollMany</code> helper function. </p>

<pre><code> describe("Ten-Ping Bowling Kata", function () {

+    function rollMany(rolls, pins) {
+        var i = 0;
+        for (i; i &lt; rolls; i ++) {
+            this.roll(pins);
+        }
+    }
+
+    beforeEach(function () {
+        this.game = new Game();
+    });
+
     describe("Gutter Game", function () {

         it("should score 0 for a gutter game, all rolls are 0", function () {
-            var game = new Game(), i = 0;
-
-            for (i; i &lt; 20; i ++) {
-                game.roll(0);
-            }
-            expect(game.score()).to.equal(0);
+            rollMany.call(this.game, 20, 0);
+            expect(this.game.score()).to.equal(0);
         });

     });


     describe("Score game given all rolls hit only one pin", function () {

         it("should score 20", function () {
-            var game = new Game(), i = 0;
-
-            for (i; i &lt; 20; i ++) {
-                game.roll(1);
-            }
-            expect(game.score()).to.equal(20);
+            rollMany.call(this.game, 20, 1);
+            expect(this.game.score()).to.equal(20);
         });

     });
</code></pre>

<h4 id="run-the-spec-yeoman-test-should-still-pass">Run the spec, <code>yeoman test</code> should still PASS</h4>

<h2 id="third-test-game-with-one-spare">Third Test, Game With One Spare</h2>

<h3 id="add-failing-test-for-a-game-with-one-spare">Add failing test for a game with one spare</h3>

<h4 id="add-helper-function-for-rolling-a-spare">Add helper function for rolling a spare</h4>

<pre><code>+    function rollSpare() {
+        this.roll(5);
+        this.roll(5);
+    }
</code></pre>

<h4 id="add-test-for-game-with-the-first-frame-as-a-spare">Add test for game with the first frame as a spare</h4>

<pre><code>+    describe("Score a game with only a spare", function () {

+        it("should score 20 given the first 3 rolls hit 5 pins", function () {
+            rollSpare.call(this.game);
+            this.game.roll(5);
+            rollMany.call(this.game, 17, 0);
+            expect(this.game.score()).to.equal(20);
+        });

+    });
</code></pre>

<h4 id="run-the-spec-yeoman-test-should-fail-3">Run the spec, <code>yeoman test</code> should FAIL</h4>

<p>You should get an error message "expected 15 to equal 20"</p>

<p>There is a design error with Game methods: roll() &amp; score() so add some TODOs and <em>skip</em> the new test for spare…</p>

<h3 id="note-incorrect-design-in-appscriptsgamejs">Note incorrect design in app/scripts/Game.js</h3>

<pre><code>+    // TODO design is wrong, responsibilities are missplaced...
+
+    // TODO roll should not calculate score
     Game.prototype.roll = function (pins) {
</code></pre>

<p>…</p>

<pre><code>+    // TODO score is not actually calculating value
     Game.prototype.score = function () {
</code></pre>

<h3 id="skip-test-in-testspecgamespecjs">Skip test in test/spec/game.spec.js</h3>

<pre><code>-    describe("Score a game with only a spare", function () {
+    describe.skip("Score a game with only a spare", function () {
</code></pre>

<h4 id="run-the-spec-yeoman-test-should-pass-new-test-was-skipped">Run the spec, <code>yeoman test</code> should PASS (new test was skipped)</h4>

<h3 id="refactor-game-methods-roll-and-score-in-appscriptsgamejs">Refactor Game methods, roll() and score(), in app/scripts/Game.js</h3>

<p>Pass tests for rolling and scoring spares…</p>

<pre><code> define('game', function () {
     var Game = function () {
-        this._score = 0;
+        this._currentRoll = 0;
+        this._rolls = [];
     };

-    // TODO design is wrong, responsibilities are missplaced...
-
-    // TODO roll should not calculate score
     Game.prototype.roll = function (pins) {
         if (typeof pins !== 'number') {
             throw new Error("expeced a number");
         }
-        this._score += pins;
+        this._rolls[this._currentRoll++] = pins;
     };

-    // TODO score is not actually calculating value
     Game.prototype.score = function () {
-        return this._score;
+        var score = 0, i = 0, 
+            rollsToScore = this._rolls.length;
+
+        for (i; i &lt; rollsToScore; i ++) {
+            if (this._rolls[i] + this._rolls[i + 1] === 10) {
+                score += 10 + this._rolls[i + 2];
+                i ++;
+            } else {
+                score += this._rolls[i];
+            }
+        }
+        return score;
+    };

     return Game;
</code></pre>

<h3 id="enable-the-skipped-test-in-testspecgamespecjs">Enable the skipped test in test/spec/game.spec.js</h3>

<pre><code>+    describe.skip("Score a game with only a spare", function () {
-    describe("Score a game with only a spare", function () {
</code></pre>

<h4 id="run-the-spec-yeoman-test-should-pass-4">Run the spec, <code>yeoman test</code> should PASS</h4>

<h2 id="fourth-test-game-with-one-strike">Fourth Test, Game With One Strike</h2>

<h3 id="add-failing-test-for-rolling-a-strike">Add failing test for rolling a strike</h3>

<p>Add helper function for testing a strike in test/spec/game.spec.js</p>

<pre><code>+    function rollStrike() {
+        this.roll(10);
+    }
</code></pre>

<p>Add test for scoring with one strike and two following rolls each hitting 4 pins</p>

<pre><code>+    describe("Score a game with only a spare", function () {
+
+        it("should score 20 given a strike followed by a two rolls hitting 2 &amp; 3 pins", function () {
+            rollStrike.call(this.game);
+            this.game.roll(2);
+            this.game.roll(3);
+            rollMany.call(this.game, 17, 0);
+            expect(this.game.score()).to.equal(20);
+        });
+    };
</code></pre>

<h4 id="run-the-spec-yeoman-test-should-fail-4">Run the spec, <code>yeoman test</code> should FAIL</h4>

<p>You should get a message "expected 15 to equal 20"</p>

<h3 id="pass-the-failing-test-with-code-edits-in-appscriptsgamejs">Pass the failing test with code edits in app/scripts/Game.js</h3>

<p>Refactor score method, add code to score a strike  </p>

<pre><code>     Game.prototype.score = function () {
-        return this._score;
+        var score = 0, i = 0, 
+            rollsToScore = this._rolls.length;
+
+        for (i; i &lt; rollsToScore; i ++) {
+            if (this._rolls[i] + this._rolls[i + 1] === 10) {
+                score += 10 + this._rolls[i + 2];
+                i ++;
+            } else if (this._isStrike(i)) {
+                score += 10 + this._rolls[i + 1] + this._rolls[i + 2];
+            } else {
+                score += this._rolls[i];
+            }
+        }
+        return score;
+    };
</code></pre>

<p>Add method to check if a roll is a strike; add a method to score the frame value for a strike</p>

<pre><code>+    Game.prototype._isStrike = function (rollIdx) {
+        return (this._rolls[rollIdx] === 10);
+    };
</code></pre>

<h4 id="run-the-spec-yeoman-test-should-pass-5">Run the spec, <code>yeoman test</code> should PASS</h4>

<h2 id="fifth-test-perfect-game-all-strikes">Fifth Test, Perfect Game - All Strikes</h2>

<h3 id="add-test-for-rolling-perfect-game-of-300-in-testspecgamespecjs">Add test for rolling perfect game of 300 in test/spec/game.spec.js</h3>

<pre><code>+    describe("Score a perfect game of 300 points", function () {

+        it("should score 300 for 12 strikes in a row", function () {
+            rollMany.call(this.game, 12, 10);
+            expect(this.game.score()).to.equal(300);
+        });

+    });
</code></pre>

<h4 id="run-the-spec-yeoman-test-should-pass-6">Run the spec, <code>yeoman test</code> should PASS</h4>

<h3 id="add-one-more-test-in-testspecgamespecjs">Add one more test in test/spec/game.spec.js</h3>

<p>As a sanity check, test a complete game with all kinds of rolls </p>

<pre><code>+    describe("Beginner's Game", function () {
+
+        it("should score 110", function () {
+            var game = this.game;
+
+            // frame 1, score: 9
+            game.roll(7);
+            game.roll(2);
+            // frame 2, score: 16
+            game.roll(6);
+            game.roll(1);
+            // frame 3, score: 26 + 3 = 29
+            rollSpare.call(game);
+            // frame 4, score: 36
+            game.roll(3);
+            game.roll(4);
+            // frame 5, score: 46 + 10 = 56
+            rollSpare.call(game);
+            // frame 6, score: 66 + 5 + 3 = 74
+            rollStrike.call(game);
+            // frame 7, score: 82
+            game.roll(5);
+            game.roll(3);
+            // frame 8, score: 87
+            game.roll(5);
+            game.roll(0);
+            // frame 9, score: 95
+            game.roll(6);
+            game.roll(2);
+            // frame 10, score: 105 + 5 = 110
+            game.roll(7);
+            game.roll(3);
+            game.roll(5);
+            expect(this.game.score()).to.equal(110);
+        });
+
+    });
</code></pre>

<h4 id="run-the-spec-yeoman-test-should-fail-5">Run the spec, <code>yeoman test</code> should FAIL</h4>

<p>You should get a message "expected 105 to equal 110"</p>

<h3 id="refactor-game-object-to-handle-scoring-the-10th-frame">Refactor Game object to handle scoring the 10th frame</h3>

<h4 id="add-method-for-checking-if-the-game-has-a-bonus-roll-in-the-10th-frame">Add method for checking if the game has a bonus roll in the 10th frame</h4>

<pre><code>+    Game.prototype._bonusRoll = function () {
+        var hasBonusRoll = false, 
+            checkRoll = this._rolls.length - 3;
+
+        if (this._isStrike(checkRoll) || this._isSpare(checkRoll)) {
+            hasBonusRoll = true;
+        }
+
+        return (hasBonusRoll) ? checkRoll : null;
+    };
</code></pre>

<h4 id="update-score-method-to-calculate-the-10th-frame-properly">Update score method to calculate the 10th frame properly</h4>

<pre><code>     Game.prototype.score = function () {
         var score = 0, i = 0, 
-            rollsToScore = this._rolls.length;
+            tenthFrameRoll = this._bonusRoll(),
+            rollsToScore = (tenthFrameRoll) ? tenthFrameRoll + 1 : this._rolls.length;
</code></pre>

<h4 id="run-the-spec-yeoman-test-should-pass-7">Run the spec, <code>yeoman test</code> should PASS</h4>

<p>Well that's a wrap from red to green over and over until the requirements are met.</p>

<h2 id="additional-topics">Additional Topics</h2>

<p>The finished test/code is on a <a href="https://github.com/pixelhandler/vagrant-dev-env/tree/bowling/www/test" title="Completed Bowling Game Test using Mocha">bowling branch</a> of my dev repository.</p>

<p>I added a few branches to my <a href="https://github.com/pixelhandler/vagrant-dev-env" title="Vagrant Development Environment">dev repository</a> showing examples of:</p>

<ul>
<li><a href="https://github.com/pixelhandler/vagrant-dev-env/tree/bowling-rjs/www/test" title="Testing a build with r.js (RequireJS optimization tool)">Testing both the development code and the build</a>  </li>
<li><a href="https://github.com/pixelhandler/vagrant-dev-env/tree/bowling-jasmine/www/test" title="Completed Bowling Game Test using Jasmine">Testing with Jasmine instead of Mocha</a>  </li>
<li><a href="https://github.com/pixelhandler/vagrant-dev-env/blob/bowling-cov/www/Makefile" title="Code Coverage using Mocha, commands in Makefile">Reporting code coverage with jscoverage and mocha</a></li>
</ul>

<p><em>Note:</em> See the Makefiles in the above branches (in the www directories) for the commands build, test, report coverage, etc.</p>

<h2 id="reference-links">Reference / Links</h2>

<ol>
<li><a href="http://butunclebob.com/ArticleS.UncleBob.TheBowlingGameKata" title="The Bowling Game Kata">Uncle Bob's The Bowling Game Kata</a></li>
<li><a href="http://en.wikipedia.org/wiki/Ten-pin_bowling" title="Ten pin bowling game Wikipedia article">Ten-pin bowling game Wikipedia article</a></li>
<li><a href="http://www.bowlingindex.com/instruction/scoring.htm" title="Scoring a bowling game">Instructions on scoring with game examples</a></li>
<li><a href="http://slocums.homestead.com/gamescore.html" title="The Basics of Keeping Score">The Basics of Keeping Score</a></li>
<li><a href="https://github.com/yeoman/yeoman" title="Yeoman source code">Yeoman.io</a></li>
<li><a href="http://visionmedia.github.com/mocha/" title="Mocha Test Framework">Mocha Test Framewor</a></li>
<li><a href="http://chaijs.com/api/bdd/" title="Chai BDD Assertion Library">Chai assertion library</a></li>
<li><a href="http://requirejs.org/docs/requirements.html" title="RequireJS Library for dependency management and build optimization">RequireJS</a></li>
<li><a href="https://github.com/pixelhandler/vagrant-dev-env" title="Vagrant Development Environment">Vagrant dev box</a></li>
<li><a href="http://blog.dannorth.net/introducing-bdd/" title="Behavior-Driven Development">Behavior-Driven Development</a></li>
<li><a href="http://en.wikipedia.org/wiki/Test-driven_development" title="Test-Driven Development">Test-Driven Development</a></li>
</ol>
</body>